<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Tini URL - URL Shortener</title>
</head>

<body class="bg-light">
    <div class="container mt-5" style="max-width: 600px;">
        <h1 class="text-center mb-4">üîó Tini URL</h1>

        <div id="auth-section" class="card p-4 shadow-sm">
            <h3 class="text-center mb-3">ƒêƒÉng Nh·∫≠p</h3>
            <form id="login-form">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="login-username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">ƒêƒÉng Nh·∫≠p</button>
            </form>
            <div id="login-error" class="text-danger mt-2 text-center"></div>
        </div>

        <div id="app-section" class="card p-4 shadow-sm" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="m-0">R√∫t g·ªçn URL</h3>
                <button id="logout-btn" class="btn btn-sm btn-outline-danger">ƒêƒÉng Xu·∫•t</button>
            </div>

            <form id="shorten-form">
                <div class="mb-3">
                    <label for="url-input" class="form-label">Nh·∫≠p link g·ªëc (B·∫Øt bu·ªôc):</label>
                    <input type="url" class="form-control" id="url-input" required placeholder="https://example.com">
                </div>
                <div class="mb-3">
                    <label for="custom-id-input" class="form-label">Custom ID (T√πy ch·ªçn):</label>
                    <input type="text" class="form-control" id="custom-id-input" placeholder="Vi-du-123">
                </div>
                <button type="submit" class="btn btn-success w-100">T·∫°o Link R√∫t G·ªçn</button>
            </form>

            <div id="result-message" class="mt-3 text-center"></div>

            <hr>
            <button id="load-history-btn" class="btn btn-secondary w-100">Xem L·ªãch S·ª≠ (Trang 1)</button>
            <ul id="history-list" class="list-group mt-3"></ul>
        </div>
    </div>

    <script>
        // --- C√ÅC BI·∫æN DOM CH√çNH ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const shortenForm = document.getElementById('shorten-form');
        const resultMessage = document.getElementById('result-message');

        // --- KI·ªÇM TRA TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P KHI LOAD TRANG ---
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (token) {
                authSection.style.display = 'none';
                appSection.style.display = 'block';
            } else {
                authSection.style.display = 'block';
                appSection.style.display = 'none';
            }
        }
        checkAuth();

        // --- X·ª¨ L√ù ƒêƒÇNG NH·∫¨P ---
        loginForm.addEventListener('submit', async (e) => {
            console.log(e);
            console.log(document.getElementById('login-username').value) ;
            console.log(document.getElementById('login-password').value) ;
            e.preventDefault(); // Ch·∫∑n h√†nh vi load l·∫°i trang c·ªßa form HTML

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                // G·ªçi API Login
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Th√†nh c√¥ng: L∆∞u token v√†o tr√¨nh duy·ªát v√† chuy·ªÉn giao di·ªán
                    localStorage.setItem('token', data.token);
                    document.getElementById('login-error').innerText = '';
                    checkAuth();
                } else {
                    // Th·∫•t b·∫°i: In ra l·ªói t·ª´ Global Error Handler c·ªßa backend
                    document.getElementById('login-error').innerText = data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('login-error').innerText = 'L·ªói k·∫øt n·ªëi ƒë·∫øn Server!';
            }
        });

        // --- ƒêƒÇNG XU·∫§T ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token'); // X√≥a token
            checkAuth(); // Quay l·∫°i m√†n h√¨nh ƒëƒÉng nh·∫≠p
            resultMessage.innerHTML = ''; // X√≥a th√¥ng b√°o c≈©
            document.getElementById('history-list').innerHTML = '';
        });

        // --- X·ª¨ L√ù R√öT G·ªåN URL ---
        shortenForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const originalUrl = document.getElementById('url-input').value;
            const customId = document.getElementById('custom-id-input').value;
            const token = localStorage.getItem('token'); // L·∫•y token ƒë·ªÉ g·ª≠i k√®m

            resultMessage.innerHTML = '<span class="text-secondary">ƒêang x·ª≠ l√Ω...</span>';

            try {
                const response = await fetch('/api/url/shorten', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` // G·∫Øn token v√†o Header
                    },
                    body: JSON.stringify({
                        'url-input': originalUrl,
                        'custom-id-input': customId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // T·∫°o ra m·ªôt th·∫ª <a> c√≥ th·ªÉ click ƒë∆∞·ª£c
                    resultMessage.innerHTML = `
                        <div class="alert alert-success">
                            Th√†nh c√¥ng! Link c·ªßa b·∫°n l√†:<br>
                            <a href="${data.shortUrl}" target="_blank" class="fw-bold">${data.shortUrl}</a>
                        </div>
                    `;
                } else {
                    // Hi·ªÉn th·ªã l·ªói (v√≠ d·ª•: Tr√πng t√™n, URL kh√¥ng h·ª£p l·ªá, Spam...)
                    resultMessage.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (err) {
                resultMessage.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi m·∫°ng</div>`;
            }
        });

        // --- XEM L·ªäCH S·ª¨ (T√≠ch h·ª£p ph√¢n trang) ---
        document.getElementById('load-history-btn').addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<li class="list-group-item text-center">ƒêang t·∫£i...</li>';

            try {
                // Truy·ªÅn tham s·ªë page=1 v√† limit=5 l√™n API
                const response = await fetch('/api/url/history?page=1&limit=5', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json(); // Nh·∫≠n v·ªÅ { data, pagination }

                if (response.ok) {
                    historyList.innerHTML = '';
                    if (result.data.length === 0) {
                        historyList.innerHTML = '<li class="list-group-item">Ch∆∞a c√≥ link n√†o ƒë∆∞·ª£c t·∫°o.</li>';
                        return;
                    }

                    // Duy·ªát qua m·∫£ng data v√† render HTML
                    result.data.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div class="text-truncate" style="max-width: 70%;">
                                <strong>${item.shortUrlId}</strong><br>
                                <small class="text-muted">${item.originalUrl}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">L∆∞·ª£t click: ${item.visitCount}</span>
                        `;
                        historyList.appendChild(li);
                    });
                }
            } catch (err) {
                historyList.innerHTML = '<li class="list-group-item text-danger">L·ªói khi t·∫£i l·ªãch s·ª≠</li>';
            }
        });
    </script>
</body>

</html>